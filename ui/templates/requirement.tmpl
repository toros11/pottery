{{template "headerpart" .}}

<div class="col-sm-12">
	<div class="panel panel-default panel-custom" id="communication_requirement_panel">
		<div class="panel-heading">
			<h1 class="panel-title">
				<span class="glyphicon glyphicon-wrench"></span> Communication Requirements
			</h1>
		</div>
		<div class="panel-body">
			<div class="row">
				<div class="col-xs-9">
					<ul class="nav nav-pills">
						<li class="active">
							<a href="#requirement_tab" data-toggle="tab"> Communication Requirements</a>
						</li>
						<li>
							<a href="#service_tab" data-toggle="tab"> Services</a>
						</li>
						<li>
							<a href="#protocol_tab" data-toggle="tab"> Protocols</a>
						</li>
					</ul>
				</div>
			</div>
			<div class="tab-content clearfix">

				<div class="tab-pane active" id="requirement_tab">
					<div class="row">
						<div class="col-xs-12">
						    &nbsp;
						</div>
					</div>
					<div class="col-sm-4">
						<div class="panel panel-default" id="edit_requirement_panel">
							<div class="panel-heading">
								<h1 class="panel-title"><span class="glyphicon glyphicon-resize-full"></span> Ports </h1>
							</div>
							<div class="panel-body">
								<table class="table">
									<tr>
										<td rowspan=2 width="20%">Form</td>
										<td width="80%"><select class="form-control" id="edit_requirement_source_node"></select></td>
									</tr>
									<tr>
										<td width="80%"><select class="form-control" id="edit_requirement_source_port"></select></td>
									</tr>
									<tr>
										<td rowspan=2>To</td>
										<td><select class="form-control" id="edit_requirement_destination_node"></select></td>
									</tr>
									<tr>
										<td><select class="form-control" id="edit_requirement_destination_port"></select></td>
									</tr>
									<tr>
										<td>Service</td>
										<td><select class="form-control" id="edit_requirement_service"></select></td>
									</tr>
									<tr>
										<td>Access</td>
										<td>
											<select class="form-control" id="edit_requirement_access">
												<option value="true">
													Allow
												</option>
												<option value="false">
													Deny
												</option>
											</select>
										</td>
									</tr>
								</table>
								<span style="float: right"><button class="btn btn-default" id="edit_add_requirement_btn" type="button"><span class="glyphicon glyphicon-ok"></span> Register</button></span>
							</div>
						</div>
					</div>
					<div class="col-sm-8">
						<div class="panel panel-default" id="edit_requirment_list_panel">
							<div class="panel-heading">
								<h1 class="panel-title"><span class="glyphicon glyphicon-transfer"></span> Communication Requirements</h1>
							</div>
							<div class="panel-body">
								<div id="edit_requirment_list_panel">
									<table class="table table-condensed table-striped" id="edit_requirements_table" style="width:100%;">
										<thead>
											<tr>
												<th>&nbsp;</th>
												<th>Source</th>
												<th>Destination</th>
												<th>Service</th>
												<th>Access</th>
											</tr>
										</thead>
										<tbody class="table table-bordered" id="edit_requirements_table_body"></tbody>
									</table>
								</div>
								<span style="float: left"><button class="btn btn-default" id="edit_delete_requirement_btn" type="button"><span class="glyphicon glyphicon-ok"></span> Delete</button></span>
							</div>
						</div>
					</div>
				</div>


				<div class="tab-pane" id="service_tab">
					<div class="row">
						<div class="col-xs-12">
								&nbsp;
						</div>
					</div>

					<div class="panel panel-default" id="edit_service_panel">
						<div class="panel-heading">
							<h1 class="panel-title"><span class="glyphicon glyphicon-transfer"></span> Services</h1>
						</div>
						<div class="panel-body">

							<!-- Left Column -->
							<div class="col-sm-4">
								<!-- Service Information Panel -->
								<div class="panel panel-default" id="services_panel">
									<!-- Service Information Panel Title -->
									<div class="panel-heading">
										<h1 class="panel-title">
											<span class="glyphicon glyphicon-file"></span> Services
										</h1>
									</div><!-- /Service Information Panel Title -->
									<!-- Service Information Panel Body -->
									<div class="panel-body">
										<!-- Service Selection -->
										<div class="input-group text-left">
											<select class="form-control" id="services"></select>
											<span class="input-group-btn">
												<button class="btn btn-default" id="edit_service_btn" type="button">
													<span class="glyphicon glyphicon-edit"></span>
												</button>
												<button class="btn btn-default" id="new_service_btn" type="button">
													<span class="glyphicon glyphicon-plus"></span>
												</button>
												<button class="btn btn-default" id="delete_service_btn" type="button">
													<span class="glyphicon glyphicon-minus"></span>
												</button>
											</span>
										</div><!-- /Service Selection -->
										<br>
										<!-- Service Properties -->
										<table class="table">
											<tr>
												<th width="50%">
													<span class="glyphicon glyphicon-file"></span> Property
												</th>
												<th width="50%">
													<span class="glyphicon glyphicon-pencil"></span> Value
												</th>
											</tr>
											<tr>
												<td>Service Name</td>
												<td>
													<span id="service_name"></span>
												</td>
											</tr>
										</table><!-- /Service Properties -->
										<!-- Service Connection Panel -->
										<div class="panel panel-default">
											<div class="panel-heading">
												<h1 class="panel-title">
													<span class="glyphicon glyphicon-list-alt"></span> Connections
												</h1>
											</div>
											<div class="panel-body">
												<div class="pre-scrollable" id="connections"></div>
											</div>
										</div><!-- /Service Connection Panel -->
									</div><!-- /Service Information Panel Body -->
								</div><!-- /Service Information Panel -->
							</div><!--/Left Column-->
							<!-- Right Column -->
							<div class="col-sm-8">
								<!-- Service Edit Panel -->
								<div class="panel panel-default" id="edit_service_panel">
									<!-- Edit-Service Panel -->
									<div class="panel-heading">
										<h3 class="panel-title">
											<span class="glyphicon glyphicon-edit"></span>
											<span id="register_or_update_service_panel_title"></span>
										</h3>
									</div>
									<div class="panel-body">
										<table class="table">
											<tr>
												<th width="15%">
													<span class="glyphicon glyphicon-file"></span> Property
												</th>
												<th width="85%">
													<span class="glyphicon glyphicon-pencil"></span> Value
												</th>
											</tr>
											<tr>
												<td width="15%">Name</td>
												<td width="85%">
													<input type="hidden" id="edit_service_id">
													<input id="edit_service_name" type="text" name="edit_service_name" placeholder="service name like ssh, http, https" class="form-control">
												</td>
											</tr>
										</table>
										<!-- Service Connection Panel -->
										<div class="panel panel-default">
											<div class="panel-heading">
												<h1 class="panel-title">
													<span class="glyphicon glyphicon-list-alt"></span> Connections
												</h1>
											</div>
											<div class="panel-body">
												<table class="table table-condensed table-striped" id="edit_connections_table">
													<thead>
														<tr>
															<th>&nbsp;</th>
															<th>Protocol</th>
															<th>Port Number</th>
														</tr>
													</thead>
													<tbody></tbody>
												</table>
											</div>
											<div style="margin-left:10px;margin-bottom:10px;">
												<span class="input-group-btn">
													<button id="edit_delete_connection_btn" type="button" class="btn btn-default">
														<span class="glyphicon glyphicon-minus"></span>
													</button>
													<button id="edit_add_connection_btn" type="button" class="btn btn-default">
														<span class="glyphicon glyphicon-plus"></span>
													</button>
													<button id="register_or_update_connection_btn" type="button" class="btn btn-default">
														<span class="glyphicon glyphicon-ok"></span>
													</button>
													<button id="cancel_register_or_update_connection_btn" type="button" class="btn btn-default">
														<span class="glyphicon glyphicon-remove"></span>
													</button>
												</span>
											</div>
										</div><!-- /Service Connection Panel -->
									</div>
								</div><!-- /Edit-Service Panel -->
							</div><!--/Right Column-->

						</div>
					</div>

				</div>


				<div class="tab-pane" id="protocol_tab">
					<div class="row">
						<div class="col-xs-12">
						    &nbsp;
						</div>
					</div>

					<div class="panel panel-default" id="edit_protocol_panel">
						<div class="panel-heading">
							<h1 class="panel-title"><span class="glyphicon glyphicon-transfer"></span> Protocols</h1>
						</div>
						<div class="panel-body">
							<table class="table table-condensed table-striped" id="edit_protocols_table">
								<thead>
									<tr>
										<th>&nbsp;</th>
										<th>Name</th>
									</tr>
								</thead>
								<tbody></tbody>
							</table>
							<div style="margin-left:10px;margin-bottom:10px;">
								<span class="input-group-btn">
									<button id="edit_delete_protocol_btn" type="button" class="btn btn-default">
										<span class="glyphicon glyphicon-minus"></span>
									</button>
									<button id="edit_add_protocol_btn" type="button" class="btn btn-default">
										<span class="glyphicon glyphicon-plus"></span>
									</button>
									<button id="register_or_update_protocol_btn" type="button" class="btn btn-default">
										<span class="glyphicon glyphicon-ok"></span>
									</button>
									<button id="cancel_register_or_update_protocol_btn" type="button" class="btn btn-default">
										<span class="glyphicon glyphicon-remove"></span>
									</button>
								</span>
							</div>
						</div>
					</div>

				</div>

			</div>
		</div>
	</div>
</div>



<script language="javascript">
	(function($) {

		{{template "functions" .}}

		var nodes = null;
		var nodeMap = null;
		var ports = null;
		var portMap = null;
		var protocols = null;
		var protocolMap = null;
		var services = null;
		var serviceMap = null;
		var requirements = null;
		var requirementMap = null;
		var editRequirementsTable = null;
		var editConnectionsTable = null;
		var editProtocolsTable = null;

		function loadResources() {
			nodes = getResources('nodes', 'preloads=NodeType').resources;
			nodeMap = buildResouceMapFromResourceArray(nodes);
			nodeMap[0] = {id: 0, name: "Internet"};
			ports = getResources('ports', 'preloads=Node&q[layer]=3').resources;
			portMap = buildResouceMapFromResourceArray(ports);
			portMap[0] = {
				id: 0,
				node_id: 0,
				name: "Internet",
				mac_address: {
				    String: "00:00:00:00:00:00",
				    Valid: true
				},
				ipv4_address: {
				    String: "0.0.0.0",
				    Valid: true
				},
				ipv4_prefix: {
				    Int64: 0,
				    Valid: true
				},
			}
			for (var i = 0; i < ports.length; i = i + 1) {
				var port = ports[i];
				var node = nodeMap[port.node_id];
				if (node.ports == null) {
					node.ports = [];
				}
				node.ports.push(port);
			}
			protocols = getResources('protocols', '').resources;
			protocolMap = buildResouceMapFromResourceArray(protocols);
			services = getResources('services', 'preloads=Connections,Connections.Protocol').resources;
			serviceMap = buildResouceMapFromResourceArray(services);
			requirements = getResources('requirements', '').resources;
		}

		function convertAccess(access) {
			if (access) {
				return "Allow";
			}
			else {
				return "Deny";
			}
		}

		function createCheckboxElement(name) {
			var checkBox = $('<input>').prop('name', name).prop('style', 'transform:scale(1.5);').prop('type', 'checkbox');
			return checkBox[0];
		}

		function createAlignedCheckboxElement(name) {
			var checkBox = $('<input>').prop('name', name).prop('style', 'transform:scale(1.5);position:relative;top:7px;').prop('type', 'checkbox');
			return checkBox[0];
		}

		function createTextElement(name, style, placeholder, value) {
			var input = $('<input>').prop('name', name).prop('class', 'form-control').prop('type', 'text').prop('style', style).prop('placeholder', placeholder).val(value).attr('value', value)[0];
			return input;
		}

		function createHiddenElement(name, value) {
			var input = $('<input>').prop('name', name).prop('type', 'hidden').val(value).attr('value', value)[0];
			return input;
		}

		function createRequiermentModelFromPanel() {
			var result = {}
			var validSource = true;
			if ($('#edit_requirement_source_port').val() == 0) {
				validSource = false;
			}
			var editRequirementSourcePortID = {
				Int64: parseInt($('#edit_requirement_source_port').val()),
				Valid: validSource
			}
			var validDestination = true;
			if ($('#edit_requirement_destination_port').val() == 0) {
				validDestination = false;
			}
			var editRequirementDestinationPortID = {
				Int64: parseInt($('#edit_requirement_destination_port').val()),
				Valid: validDestination
			}
			var editRequirementServiceID = $('#edit_requirement_service').val();
			var editRequirementAccess = $('#edit_requirement_access').val();
			result = {
				source_port_id: editRequirementSourcePortID,
				destination_port_id: editRequirementDestinationPortID,
				service_id: parseInt(editRequirementServiceID),
				access: convertStringToBoolean(editRequirementAccess)
			}
			return result;
		}

		function onRequirementModified(result, successCode, successMessage, ignoreSuccess) {
			if (result.status == successCode) {
				if (!ignoreSuccess) {
					$('html,body').animate({
						scrollTop: 0
					}, 'slow');
					$('#information_message').text(successMessage);
					$('#alert_info').fadeIn(500).delay(2000).fadeOut(1000);
					$('#edit_panel').fadeOut(150);
					loadResources();
					showRequirements();
				}
				return true;
			}
			else {
				$('html,body').animate({
					scrollTop: 0
				}, 'slow');
				$('#error_message').text(result.resource.error);
				$('#alert_error').fadeIn(500).delay(2000).fadeOut(1000);
				return false;
			}
		}

		function showRequirements() {
			$("#edit_requirement_source_node").children().remove();
			$("#edit_requirement_destination_node").children().remove();
			$("#edit_requirement_source_port").children().remove();
			$("#edit_requirement_destination_port").children().remove();
			$("#edit_requirement_service").children().remove();
			$("#edit_requirement_access").val('true');
			$("#edit_requirements_table_body").children().remove();
			editRequirementsTable.fnClearTable();

			$("#edit_requirement_source_node").append($('<option>').val(0).text('Internet'));
			$("#edit_requirement_destination_node").append($('<option>').val(0).text('Internet'));
			$("#edit_requirement_source_port").append($('<option>').val(0).text('Internet (0.0.0.0/0)'));
			$("#edit_requirement_destination_port").append($('<option>').val(0).text('Internet (0.0.0.0/0)'));

			for (var i = 0; i < nodes.length; i = i + 1) {
				var node = nodes[i];
				if (node.ports != null) {
					$("#edit_requirement_source_node").append($('<option>').val(node.id).text(node.name));
					$("#edit_requirement_destination_node").append($('<option>').val(node.id).text(node.name));
				}
			}

			for (var i = 0; i < services.length; i = i + 1) {
				var service = services[i]
				$("#edit_requirement_service").append($('<option>').val(service.id).text(service.name));
			}

			for (var i = 0; i < requirements.length; i = i + 1) {
				var requirement = requirements[i]
				var sourcePort = portMap[requirement.source_port_id.Int64];
				var sourceNode = nodeMap[sourcePort.node_id];
				var destinationPort = portMap[requirement.destination_port_id.Int64];
				var destinationNode = nodeMap[destinationPort.node_id];
				var service = serviceMap[requirement.service_id];
				editRequirementsTable.fnAddData([
					createCheckboxElement('edit_requirement_check').outerHTML + createHiddenElement('edit_requirement_id', requirement.id).outerHTML,
					sourceNode.name + " - " + sourcePort.name + " (" + sourcePort.ipv4_address.String + "/" + sourcePort.ipv4_prefix.Int64 + ")",
					destinationNode.name + " - " + destinationPort.name + " (" + destinationPort.ipv4_address.String + "/" + destinationPort.ipv4_prefix.Int64 + ")",
					service.name,
					convertAccess(requirement.access)
				]);
			}
		}

		function onEditRequirementSourceNodeChanged(selector) {
			var editRequirementSourceNodeID = $(selector.currentTarget).val();

			$('#edit_requirement_source_port').children().remove();

			if (editRequirementSourceNodeID == 0) {
				$('#edit_requirement_source_port').append($('<option>').val(0).text('Internet (0.0.0.0/0)'));
			} else {
				var node = nodeMap[editRequirementSourceNodeID];
				var ports = node.ports;
				for (var i = 0; i < ports.length; i = i + 1) {
					var port = portMap[ports[i].id];
					if (port.layer == 3) {
						$('#edit_requirement_source_port').append($('<option>').val(port.id).text(port.name + ' (' + port.ipv4_address.String + '/' + port.ipv4_prefix.Int64 + ')'));
					}
				}
			}
		}

		function onEditRequirementDestinationNodeChanged(selector) {
			var editRequirementDestinationNodeID = $(selector.currentTarget).val();

			$('#edit_requirement_destination_port').children().remove();

			if (editRequirementDestinationNodeID == 0) {
				$('#edit_requirement_destination_port').append($('<option>').val(0).text('Internet (0.0.0.0/0)'));
			} else {
				var node = nodeMap[editRequirementDestinationNodeID];
				var ports = node.ports;
				for (var i = 0; i < ports.length; i = i + 1) {
					var port = portMap[ports[i].id];
					if (port.layer == 3) {
						$('#edit_requirement_destination_port').append($('<option>').val(port.id).text(port.name + ' (' + port.ipv4_address.String + '/' + port.ipv4_prefix.Int64 + ')'));
					}
				}
			}
		}

		$('#edit_requirement_source_node').on('change', function(selector) {
			onEditRequirementSourceNodeChanged(selector);
		});

		$('#edit_requirement_destination_node').on('change', function(selector) {
			onEditRequirementDestinationNodeChanged(selector);
		});

		function onLoad() {
			$.fn.dataTable.ext.order['dom-text'] = function  ( settings, col )
			{
					return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i ) {
							return $('input', td).val();
					} );
			}
			$.fn.dataTable.ext.order['dom-select'] = function  ( settings, col )
			{
					return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i ) {
							return $('select', td).val();
					} );
			}
			editProtocolsTable = $('#edit_protocols_table').dataTable({
				scrollX: true,
				scrollY: 250,
				searching: false,
				columns: [
					null,
					{ orderDataType: 'dom-select' }
				]
			});
			editConnectionsTable = $('#edit_connections_table').dataTable({
				scrollX: true,
				scrollY: 250,
				searching: false,
				columns: [
					null,
					{ orderDataType: 'dom-select' },
					{ orderDataType: 'dom-text', type: 'string' }
				]
			});
			editRequirementsTable = $('#edit_requirements_table').dataTable({
				scrollX: true,
				scrollY: 250,
				searching: true
			});

			loadResources();
			$('#communication_requirement_panel').fadeIn(150);
			showRequirements();
		}

		$('#edit_add_requirement_btn').on('click', function() {
			if (!confirm("Are you sure to register?")) {
				return;
			}

			var requirementForRegistration = createRequiermentModelFromPanel();
			var result = postResource('requirements', requirementForRegistration);
			onRequirementModified(result, 201, 'The requirement has been registered successfully', false);
		});

		$('#edit_delete_requirement_btn').on('click', function(selector) {
			var rows = editRequirementsTable.fnGetNodes();
			var rowCount = rows.length;

			var selectedRowCount = 0;
			for (var i = 0; i < rowCount; i = i + 1) {
				var row = rows[i];
				if ($(row).find('input[name=edit_requirement_check]').prop('checked')) {
					selectedRowCount = selectedRowCount + 1;
				}
			}

			if (selectedRowCount == 0) {
				alert('Check the requirements what you want to delete first');
				return;
			}

			if (!confirm('Are you sure to delete selected requirements?')) {
				return;
			}

			for (var i = rowCount - 1; 0 <= i; i = i - 1) {
				var row = rows[i];
				if ($(row).find('input[name=edit_requirement_check]').prop('checked')) {
					var deletedRequirementID = parseInt($(row).find('input[name=edit_requirement_id]').val(), 0);
					var result = deleteResource('requirements', deletedRequirementID);
					if (!onRequirementModified(result, 204, null, true)) {
						return;
					}
				}
			}
			onRequirementModified({status: 204}, 204, "The requirements has been deleted successfully", false);
		});

		onLoad();

	})(jQuery);
</script>
{{template "footerpart" .}}
